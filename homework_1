import streamlit as st
from streamlit_extras.colored_header import colored_header
from streamlit_extras.add_vertical_space import add_vertical_space
import json
import requests
from bs4 import BeautifulSoup as bs

class pars():
    def __init__(self):
        pass
    def pars_cb(self):
        url = 'https://cbr.ru/currency_base/daily/'
        try:
            page = requests.get(url)
        except:
            print("–°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞!")
        soup = bs(page.text, "html.parser")
        table = soup.find('div', class_='table')
        rows = table.find_all('tr')
        self.list = {}
        date = soup.find("button", class_="datepicker-filter_button").text
        name = soup.find("span", class_="referenceable").text
        for index, i in enumerate(rows):
            local_t = i.find_all('td')
            if local_t != []:
                self.list[local_t[1].text] = [j.text for j in local_t[2:]]
                self.list[local_t[1].text][0] = int(self.list[local_t[1].text][0])
                self.list[local_t[1].text][2] = float(self.list[local_t[1].text][2].replace(",", "."))
        with open(f"{name}_{date}.json", "w", encoding="utf-8") as f:
            json.dump(self.list, f, ensure_ascii=False, indent=4)
pars = pars()
pars.pars_cb()
# –ü—Ä–∏–º–µ—Ä –∑–∞–≥–ª—É—à–∫–∏ (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à—É —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é)
def get_exchange_rate(from_curr: str, to_curr: str) -> float:
    # –ü—Ä–∏–º–µ—Ä —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫—É—Ä—Å–æ–≤ (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥)
    from_curr_rub = pars.list[from_curr][2]/pars.list[from_curr][0]
    to_curr_rub = pars.list[to_curr][2]/pars.list[to_curr][0]
    return from_curr_rub/to_curr_rub

def get_supported_currencies():
    return pars.list.keys()

# === Streamlit UI ===
st.set_page_config(page_title="üí± –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –≤–∞–ª—é—Ç", page_icon="üí±", layout="centered")

# –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∞–∫—Ü–µ–Ω—Ç–æ–º
colored_header(
    label="üí± –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –≤–∞–ª—é—Ç",
    description="–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–π—Ç–µ –º–µ–∂–¥—É –≤–∞–ª—é—Ç–∞–º–∏",
    color_name="blue-70",
)

add_vertical_space(1)

# –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤–∞–ª—é—Ç
currencies = get_supported_currencies()

# –í—ã–±–æ—Ä –≤–∞–ª—é—Ç
col1, col2 = st.columns(2)

with col1:
    from_currency = st.selectbox("–ò–∑ –≤–∞–ª—é—Ç—ã", currencies, index=0)

with col2:
    to_currency = st.selectbox("–í –≤–∞–ª—é—Ç—É", currencies, index=1)

# –í–≤–æ–¥ —Å—É–º–º—ã
amount = st.number_input(
    f"–°—É–º–º–∞ –≤ {from_currency}({pars.list[from_currency][1]})",
    min_value=0.0,
    value=100.0,
    step=10.0,
    format="%.2f"
)

# –†–∞—Å—á—ë—Ç
if from_currency == to_currency:
    converted = amount
else:
    rate = get_exchange_rate(from_currency, to_currency)
    converted = amount * rate

# –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
st.markdown("---")
st.subheader("–†–µ–∑—É–ª—å—Ç–∞—Ç")
st.markdown(
    f"""
    <div style="
        background-color: #f0f8ff;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        font-size: 24px;
        font-weight: bold;
        color: #2c3e50;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    ">
        {amount:,.2f} {from_currency} = {converted:,.2f} {to_currency}
    </div>
    """,
    unsafe_allow_html=True
)

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –ø–æ–∫–∞–∑–∞—Ç—å –∫—É—Ä—Å
if from_currency != to_currency:
    st.caption(f"–ö—É—Ä—Å: 1 {pars.list[from_currency][1]} = {rate:.4f} {pars.list[to_currency][1]}")
